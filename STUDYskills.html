<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySkills - AI Powered Learning</title>
    <link rel="stylesheet" href="mwui/framework.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 60vh;
            border: 1px solid var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--surface);
        }
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-input-area {
            padding: 1rem;
            background: rgba(0,0,0,0.02);
            border-top: 1px solid var(--shadow);
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user-msg {
            align-self: flex-end;
            background: var(--primary);
            color: var(--on-primary);
            border-bottom-right-radius: 2px;
        }
        .ai-msg {
            align-self: flex-start;
            background: rgba(0,0,0,0.05);
            color: var(--on-surface);
            border-bottom-left-radius: 2px;
        }
        .chat-bubble strong { font-weight: bold; }
        .chat-bubble em { font-style: italic; }
        .chat-bubble code { background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .diagram-container {
            width: 100%;
            min-height: 300px;
            background: #fff;
            border: 2px solid var(--shadow);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .diagram-container svg {
            max-width: 100%;
            max-height: 400px;
        }
        .flashcard {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            background: var(--surface);
            border: 1px solid var(--shadow);
            position: relative;
            transform-style: preserve-3d;
        }
        .flashcard:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow); }
        .loader {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .live-indicator {
            width: 12px;
            height: 12px;
            background-color: #ccc;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .live-indicator.active {
            background-color: var(--error);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 40px;
            margin-top: 10px;
        }
        .audio-bar {
            width: 6px;
            background-color: var(--primary);
            border-radius: 3px;
            height: 10px;
            transition: height 0.1s ease;
        }
        body.dyslexia-font {
            font-family: 'Open Dyslexic', 'Comic Sans MS', 'Verdana', sans-serif !important;
            line-height: 1.6;
            letter-spacing: 0.05em;
        }
        .reduced-motion * {
            animation: none !important;
            transition: none !important;
        }
        .show-focus-outlines :focus {
            outline: 3px solid var(--primary) !important;
            outline-offset: 2px;
        }
        .invert-colors {
            filter: invert(1) hue-rotate(180deg);
            background-color: inherit;
        }
        .magnifier-mode {
            transform-origin: 0 0;
            transform: scale(1.15);
        }
        .sr-live {
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            overflow: hidden !important;
        }
        .hidden { display: none !important; }
        .error-banner {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body class="material3" data-theme="light">
    <div class="header">
        <div class="title">
            <i class="material-icons" style="vertical-align: bottom;">school</i> StudySkills AI
        </div>
        <div class="controls">
            <button id="settingsBtn" aria-label="Open Settings">⚙️ Settings</button>
        </div>
    </div>
    <div id="apiKeyWarning" class="error-banner hidden">
        <strong>Setup Required:</strong> Please go to Settings and enter your Gemini API Key to enable AI features.
    </div>
    <div class="tabs" role="tablist">
        <button class="tab-link active" onclick="openTab(event, 'tutor')" role="tab">
            <i class="material-icons">chat</i> AI Tutor
        </button>
        <button class="tab-link" onclick="openTab(event, 'live')" role="tab">
            <i class="material-icons">mic</i> Live Tutor
        </button>
        <button class="tab-link" onclick="openTab(event, 'notebook')" role="tab">
            <i class="material-icons">book</i> Notebook
        </button>
        <button class="tab-link" onclick="openTab(event, 'flashcards')" role="tab">
            <i class="material-icons">style</i> Practice
        </button>
        <button class="tab-link" onclick="openTab(event, 'visualize')" role="tab">
            <i class="material-icons">draw</i> Visualize
        </button>
        <button class="tab-link" onclick="openTab(event, 'converter')" role="tab">
            <i class="material-icons">record_voice_over</i> Convert
        </button>
        <button class="tab-link" onclick="openTab(event, 'access')" role="tab">
            <i class="material-icons">accessibility_new</i> Tools
        </button>
    </div>
    <div id="tutor" class="tab-content" style="display: block;" role="tabpanel">
        <div class="card" style="height: 100%; padding: 0;">
            <div class="chat-container">
                <div id="chatHistory" class="chat-history">
                    <div class="chat-bubble ai-msg">
                        Hello! I am your AI Tutor. I can explain complex topics, answer questions, or just chat. You can type or speak to me.
                    </div>
                </div>
                <div class="chat-input-area">
                    <button class="btn-icon" id="tutorMicBtn" onclick="toggleTutorMic()" aria-label="Toggle Microphone">
                        <i class="material-icons">mic</i>
                    </button>
                    <textarea id="tutorInput" rows="1" style="flex:1; resize:none; padding:10px; border-radius:20px; border:1px solid #ccc;" placeholder="Ask me anything..."></textarea>
                    <button class="btn-primary" onclick="handleTutorSend()" id="tutorSendBtn" aria-label="Send Message">
                        <i class="material-icons">send</i>
                    </button>
                </div>
            </div>
            <div style="padding: 0.5rem; text-align: center; font-size: 0.8rem; color: var(--primary);">
                <label>
                    <input type="checkbox" id="useNotebookContext" checked> Use Notebook Context
                </label>
            </div>
        </div>
    </div>
    <div id="live" class="tab-content" role="tabpanel">
        <div class="card ui-customizable">
            <h2><i class="material-icons">record_voice_over</i> Live AI Tutor</h2>
            <p>Speak naturally with your AI tutor in real-time. Good for practice and quick questions.</p>
            <div style="text-align: center; margin: 2rem 0;">
                <div id="liveIndicator" class="live-indicator"></div>
                <span id="liveStatus">Disconnected</span>
                <div class="audio-visualizer" id="audioVisualizer">
                    <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                    <div class="audio-bar"></div><div class="audio-bar"></div>
                </div>
                <div style="margin-top: 2rem;">
                    <button id="connectLiveBtn" onclick="toggleLiveConnection()" class="btn-primary">
                        <i class="material-icons">power_settings_new</i> Start Session
                    </button>
                    <button id="muteLiveBtn" onclick="toggleLiveMute()" class="btn-secondary" disabled>
                        <i class="material-icons">mic</i> Mute
                    </button>
                </div>
            </div>
            <div class="card" style="margin-top: 1rem; background: rgba(0,0,0,0.02);">
                <h3><i class="material-icons">subtitles</i> Live Transcript</h3>
                <div id="liveTranscript" style="min-height: 100px; max-height: 200px; overflow-y: auto; font-family: monospace; line-height: 1.5;">
                    <em style="color:#888;">Transcript will appear here...</em>
                </div>
            </div>
        </div>
    </div>
    <div id="notebook" class="tab-content" role="tabpanel">
        <div class="card ui-customizable">
            <h2><i class="material-icons">book</i> Study Notebook</h2>
            <p>Paste your study notes, articles, or essays here. The AI will use this context to answer your questions.</p>
            <div class="form-group">
                <textarea id="notebookContent" rows="15" placeholder="Paste your study material here..." style="width: 100%; padding: 1rem;"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button onclick="saveNotebook()" class="btn-primary">Save Notes</button>
                <button onclick="clearNotebook()" class="btn-secondary">Clear</button>
                <button onclick="summarizeNotebook()" class="btn-secondary">Summarize Notes</button>
            </div>
        </div>
    </div>
    <div id="flashcards" class="tab-content" role="tabpanel">
        <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            <div class="card ui-customizable">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>Flashcards</h3>
                    <button onclick="generateNewDeck()" id="newDeckBtn" class="btn-secondary" style="font-size:0.8rem;">
                        <i class="material-icons">add</i> Auto-Gen
                    </button>
                </div>
                <div class="flashcard" id="activeFlashcard" onclick="flipCard()" tabindex="0" role="button" aria-label="Flashcard. Tap to flip.">
                    <div id="cardContent">
                    </div>
                </div>
                <div class="controls" style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
                    <button onclick="prevCard()" aria-label="Previous Card"><i class="material-icons">arrow_back</i></button>
                    <button onclick="readCard()" aria-label="Read Card Aloud"><i class="material-icons">volume_up</i></button>
                    <button onclick="nextCard()" aria-label="Next Card"><i class="material-icons">arrow_forward</i></button>
                </div>
            </div>
            <div class="card ui-customizable">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>Quiz Mode</h3>
                    <button onclick="generateQuiz()" id="newQuizBtn" class="btn-secondary" style="font-size:0.8rem;">
                        <i class="material-icons">quiz</i> New Quiz
                    </button>
                </div>
                <div id="quizContainer">
                    <p style="color:#666; text-align: center; padding: 2rem;">
                        Generate a quiz based on your Notebook content or a specific topic.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="visualize" class="tab-content" role="tabpanel">
        <div class="dashboard-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <div class="card ui-customizable">
                <h2>Generate Diagrams</h2>
                <p>The AI will write code to draw a diagram for you.</p>
                <div class="form-group">
                    <label for="diagramPrompt">What should I draw?</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="diagramPrompt" placeholder="e.g., A flow chart of the water cycle" style="flex:1">
                        <button onclick="generateRealDiagram()" id="genDiagBtn">Generate</button>
                    </div>
                </div>
            </div>
            <div class="card ui-customizable">
                <div class="diagram-container" id="svgContainer" role="img" aria-label="Generated Diagram">
                    <span style="color:#888">Visual Output Area</span>
                </div>
                <div class="form-group">
                    <label><strong>Audio Description:</strong></label>
                    <p id="diagramDesc" style="font-size: 0.9rem; padding: 0.5rem; background: rgba(0,0,0,0.05); border-radius: 4px;">
                        Description will appear here.
                    </p>
                    <button onclick="speakText(document.getElementById('diagramDesc').textContent)" class="btn-sm">
                        <i class="material-icons">volume_up</i> Read Description
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="converter" class="tab-content" role="tabpanel">
        <div class="card ui-customizable">
            <h2><i class="material-icons">swap_horiz</i> Format Converter</h2>
            <div class="form-group">
                <label for="textInput">Input Text (or Dictate):</label>
                <textarea id="textInput" rows="5" placeholder="Paste text here..."></textarea>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button onclick="speakInputText()" class="btn-primary">
                    <i class="material-icons">volume_up</i> Listen (TTS)
                </button>
                <button onclick="toggleDictation('textInput')" id="convMicBtn" class="btn-secondary">
                    <i class="material-icons">mic</i> Record (STT)
                </button>
                <button onclick="runAISummary()" class="btn-secondary" id="sumBtn">
                    <i class="material-icons">auto_awesome</i> AI Summarize
                </button>
            </div>
        </div>
        <div class="card ui-customizable" style="margin-top: 1rem;">
            <h3>Summary Output</h3>
            <div id="summaryOutput" class="output-area">
                <em>Summarization results will appear here...</em>
            </div>
        </div>
    </div>
    <div id="access" class="tab-content" role="tabpanel">
        <h2>Inclusive Tools</h2>
        <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div class="card">
                <h3><i class="material-icons">text_fields</i> Text & Typographic Aids</h3>
                <div class="form-group">
                    <label for="accessFontSize">Text Size</label>
                    <input type="range" id="accessFontSize" min="12" max="32" value="16">
                </div>
                <div class="form-group toggle-group">
                    <label for="textSpacingToggle">Increased Letter & Word Spacing</label>
                    <label class="switch">
                        <input type="checkbox" id="textSpacingToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group toggle-group">
                    <label for="dyslexiaToggle">OpenDyslexic Font</label>
                    <label class="switch">
                        <input type="checkbox" id="dyslexiaToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="card">
                <h3><i class="material-icons">visibility</i> Display & Motion</h3>
                <div class="form-group toggle-group">
                    <label for="reducedMotionToggle">Reduce Motion</label>
                    <label class="switch">
                        <input type="checkbox" id="reducedMotionToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group toggle-group">
                    <label for="focusOutlineToggle">Always Show Focus Outlines</label>
                    <label class="switch">
                        <input type="checkbox" id="focusOutlineToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group toggle-group">
                    <label for="invertColorsToggle">High Contrast (Invert)</label>
                    <label class="switch">
                        <input type="checkbox" id="invertColorsToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="card">
                <h3><i class="material-icons">hearing</i> Assistive Tools</h3>
                <div class="form-group toggle-group">
                    <label for="screenReaderToggle">Screen Reader Mode (Auto-Read)</label>
                    <label class="switch">
                        <input type="checkbox" id="screenReaderToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <button id="readPageBtn" onclick="readCurrentView()">Read Current View</button>
                    <button id="showShortcutsBtn" onclick="showKeyboardShortcuts()">Keyboard Shortcuts</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="settingsTitle">Settings</div>
                <button class="close-btn" id="closeSettings" aria-label="Close Settings">&times;</button>
            </div>
            <div class="form-group">
                <label for="apiKeyInput" style="color: var(--primary); font-weight:bold;">Gemini API Key (Required)</label>
                <input type="password" id="apiKeyInput" placeholder="Paste your API key here">
                <small>Get a key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</small>
            </div>
            <hr style="margin: 1rem 0; border: 0; border-top: 1px solid var(--shadow);">
            <div class="form-group">
                <label for="themeSelect">Theme:</label>
                <select id="themeSelect">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="high-contrast">High Contrast</option>
                </select>
            </div>
            <div class="form-group">
                <label for="accentColorInput">Accent Color:</label>
                <input type="color" id="accentColorInput" value="#1976d2">
            </div>
            <div class="form-group">
                <label for="fontSizeSlider">Base Font Size:</label>
                <input type="range" id="fontSizeSlider" min="12" max="24" value="16">
            </div>
            <div class="form-group toggle-group">
                <label for="highContrastToggle">High Contrast Mode</label>
                <label class="switch">
                    <input type="checkbox" id="highContrastToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <hr style="margin: 1rem 0; border: 0; border-top: 1px solid var(--shadow);">
            <button id="saveSettingsBtn">Save & Close</button>
        </div>
    </div>
    <script src="mwui/framework.js"></script>
    <script src="mwui/customizer.js"></script>
    <script>
        let API_KEY = localStorage.getItem('study_skills_api_key') || '';
        let recognition = null;
        let isRecording = false;
        let notebookContent = localStorage.getItem('study_notebook') || '';
        document.getElementById('notebookContent').value = notebookContent;
        const app = new UIFramework({
            appName: 'StudySkills',
            defaultTheme: 'light',
            defaultStyle: 'material3'
        });
        async function callGemini(prompt, systemInstruction = "") {
            if (!API_KEY) {
                app.showModal('settingsModal');
                throw new Error("API Key Missing");
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
            let finalSystemInstruction = systemInstruction;
            const useContext = document.getElementById('useNotebookContext')?.checked;
            if (useContext && notebookContent) {
                finalSystemInstruction += `\n\nCONTEXT FROM NOTEBOOK:\n${notebookContent}\n\nUse this context to answer if relevant.`;
            }
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };
            if (finalSystemInstruction) {
                payload.systemInstruction = {
                    parts: [{ text: finalSystemInstruction }]
                };
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "API Error");
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                alert("AI Error: " + error.message);
                return null;
            }
        }
        async function handleTutorSend() {
            const input = document.getElementById('tutorInput');
            const history = document.getElementById('chatHistory');
            const sendBtn = document.getElementById('tutorSendBtn');
            const text = input.value.trim();
            if (!text) return;
            history.innerHTML += `<div class="chat-bubble user-msg">${escapeHtml(text)}</div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;
            const loadingId = 'loading-' + Date.now();
            history.innerHTML += `<div id="${loadingId}" class="chat-bubble ai-msg"><div class="loader"></div> Thinking...</div>`;
            sendBtn.disabled = true;
            try {
                const systemPrompt = "You are a patient, inclusive, and encouraging tutor. Keep explanations simple. Use analogies.";
                const response = await callGemini(text, systemPrompt);
                document.getElementById(loadingId).remove();
                if (response) {
                    const formatted = parseMarkdown(response);
                    history.innerHTML += `<div class="chat-bubble ai-msg">${formatted}</div>`;
                    speakText(response); 
                }
            } catch (e) {
                document.getElementById(loadingId).innerHTML = "Error connecting to AI.";
            }
            sendBtn.disabled = false;
            history.scrollTop = history.scrollHeight;
        }
        function toggleTutorMic() {
            toggleDictation('tutorInput');
        }
        class GeminiLiveClient {
            constructor() {
                this.socket = null;
                this.audioContext = null;
                this.processor = null;
                this.inputSource = null;
                this.isConnected = false;
                this.nextScheduledTime = 0;
            }
            async connect() {
                if (!API_KEY) {
                    alert("Please set your API Key first.");
                    return;
                }
                const url = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1beta.GenerativeService.BidiGenerateContent?key=${API_KEY}`;
                this.socket = new WebSocket(url);
                this.socket.onopen = () => {
                    this.isConnected = true;
                    this.updateUI(true);
                    const setupMsg = {
                        setup: {
                            model: "models/gemini-2.0-flash-exp",
                            generation_config: { response_modalities: ["AUDIO", "TEXT"] }
                        }
                    };
                    this.socket.send(JSON.stringify(setupMsg));
                    this.startAudioInput();
                };
                this.socket.onmessage = async (event) => {
                    let data;
                    if (event.data instanceof Blob) {
                        data = JSON.parse(await event.data.text());
                    } else {
                        data = JSON.parse(event.data);
                    }
                    this.handleMessage(data);
                };
                this.socket.onclose = () => this.disconnect();
                this.socket.onerror = (e) => {
                    console.error("WebSocket Error", e);
                    this.disconnect();
                };
            }
            handleMessage(data) {
                if (data.serverContent) {
                    const parts = data.serverContent.modelTurn?.parts || [];
                    for (const part of parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('audio/pcm')) {
                            this.playAudioChunk(part.inlineData.data);
                        }
                        if (part.text) {
                            this.appendTranscript(part.text);
                        }
                    }
                }
            }
            async startAudioInput() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 16000 } });
                this.inputSource = this.audioContext.createMediaStreamSource(stream);
                this.processor = this.audioContext.createScriptProcessor(512, 1, 1);
                this.processor.onaudioprocess = (e) => {
                    if (!this.isConnected) return;
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcm16 = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        let s = Math.max(-1, Math.min(1, inputData[i]));
                        pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    const base64Audio = this.arrayBufferToBase64(pcm16.buffer);
                    const msg = {
                        realtime_input: {
                            media_chunks: [{
                                mime_type: "audio/pcm;rate=16000",
                                data: base64Audio
                            }]
                        }
                    };
                    if (this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify(msg));
                        this.updateVisualizer(inputData);
                    }
                };
                this.inputSource.connect(this.processor);
                this.processor.connect(this.audioContext.destination);
            }
            playAudioChunk(base64Data) {
                if (!this.audioContext) return;
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const int16 = new Int16Array(bytes.buffer);
                const float32 = new Float32Array(int16.length);
                for (let i = 0; i < int16.length; i++) {
                    float32[i] = int16[i] / 32768.0;
                }
                const buffer = this.audioContext.createBuffer(1, float32.length, 24000);
                buffer.getChannelData(0).set(float32);
                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(this.audioContext.destination);
                const now = this.audioContext.currentTime;
                const playTime = Math.max(now, this.nextScheduledTime);
                source.start(playTime);
                this.nextScheduledTime = playTime + buffer.duration;
            }
            appendTranscript(text) {
                const div = document.getElementById('liveTranscript');
                const span = document.createElement('span');
                span.textContent = text + " ";
                div.appendChild(span);
                div.scrollTop = div.scrollHeight;
            }
            updateVisualizer(data) {
                const bars = document.querySelectorAll('.audio-bar');
                let sum = 0;
                for(let i=0; i<data.length; i+=10) sum += Math.abs(data[i]);
                const avg = sum / (data.length/10) * 50; 
                bars.forEach(b => b.style.height = Math.min(40, Math.max(5, avg * Math.random() * 10)) + 'px');
            }
            arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            updateUI(connected) {
                const status = document.getElementById('liveStatus');
                const btn = document.getElementById('connectLiveBtn');
                const ind = document.getElementById('liveIndicator');
                if (connected) {
                    status.textContent = "Connected (Listening...)";
                    btn.innerHTML = '<i class="material-icons">stop</i> End Session';
                    btn.classList.replace('btn-primary', 'btn-error');
                    ind.classList.add('active');
                } else {
                    status.textContent = "Disconnected";
                    btn.innerHTML = '<i class="material-icons">power_settings_new</i> Start Session';
                    btn.classList.replace('btn-error', 'btn-primary');
                    ind.classList.remove('active');
                }
            }
            disconnect() {
                this.isConnected = false;
                if (this.socket) this.socket.close();
                if (this.processor) this.processor.disconnect();
                if (this.inputSource) this.inputSource.disconnect();
                if (this.audioContext) this.audioContext.close();
                this.socket = null;
                this.updateUI(false);
            }
        }
        const liveClient = new GeminiLiveClient();
        function toggleLiveConnection() {
            if (liveClient.isConnected) liveClient.disconnect();
            else liveClient.connect();
        }
        function saveNotebook() {
            const content = document.getElementById('notebookContent').value;
            notebookContent = content;
            localStorage.setItem('study_notebook', content);
            alert('Notebook context saved!');
        }
        function clearNotebook() {
            if(confirm("Clear notebook?")) {
                document.getElementById('notebookContent').value = "";
                notebookContent = "";
                localStorage.setItem('study_notebook', "");
            }
        }
        async function summarizeNotebook() {
            if (!notebookContent) { alert("Notebook is empty."); return; }
            const prompt = "Summarize the following notes in detail:";
            const system = `CONTEXT: ${notebookContent}`;
            openTab(null, 'tutor');
            const history = document.getElementById('chatHistory');
            history.innerHTML += `<div class="chat-bubble user-msg">Summarize my notebook.</div>`;
            const loadingId = 'load-nb-' + Date.now();
            history.innerHTML += `<div id="${loadingId}" class="chat-bubble ai-msg">Summarizing...</div>`;
            const response = await callGemini(prompt, system);
            document.getElementById(loadingId).remove();
            if (response) {
                history.innerHTML += `<div class="chat-bubble ai-msg">${parseMarkdown(response)}</div>`;
            }
        }
        let flashcardDeck = [
            { q: "Welcome", a: "Use 'Auto-Gen' to create cards on any topic!" }
        ];
        let currentCardIdx = 0;
        let isCardFlipped = false;
        async function generateNewDeck() {
            const topic = prompt("What topic do you want to study?");
            if (!topic) return;
            const btn = document.getElementById('newDeckBtn');
            const oldText = btn.innerHTML;
            btn.innerHTML = '...';
            btn.disabled = true;
            const prompt = `Create 5 flashcards about "${topic}". Return JSON array only: [{"q": "Question", "a": "Answer"}]. No markdown.`;
            const response = await callGemini(prompt);
            btn.disabled = false;
            btn.innerHTML = oldText;
            if (response) {
                try {
                    const cleanJson = response.replace(/```json|```/g, '').trim();
                    flashcardDeck = JSON.parse(cleanJson);
                    currentCardIdx = 0;
                    isCardFlipped = false;
                    renderCard();
                    alert(`Created ${flashcardDeck.length} cards.`);
                } catch (e) {
                    alert("Error parsing AI response.");
                }
            }
        }
        async function generateQuiz() {
             const topic = prompt("Quiz topic (or leave empty to use Notebook)?");
             let context = "";
             if (!topic && notebookContent) context = `Based on these notes: ${notebookContent}`;
             else if (topic) context = `Topic: ${topic}`;
             else { alert("Provide a topic or fill your notebook."); return; }
             const container = document.getElementById('quizContainer');
             container.innerHTML = '<div class="loader"></div> Generating Quiz...';
             const prompt = `Create a 3-question multiple choice quiz. 
             Return JSON only: [{"q": "Question", "options": ["A", "B", "C", "D"], "correct": 0}]. 
             ${context}`;
             const response = await callGemini(prompt);
             if (response) {
                 try {
                     const cleanJson = response.replace(/```json|```/g, '').trim();
                     const quiz = JSON.parse(cleanJson);
                     let html = '';
                     quiz.forEach((item, idx) => {
                         html += `<div style="margin-bottom:1.5rem; border-bottom:1px solid #eee; padding-bottom:1rem;">
                            <strong>Q${idx+1}: ${item.q}</strong><br>`;
                         item.options.forEach((opt, oIdx) => {
                             html += `<div style="margin: 5px 0;">
                                <button onclick="checkAnswer(this, ${oIdx === item.correct})" class="btn-sm" style="width:100%; text-align:left;">
                                    ${opt}
                                </button>
                             </div>`;
                         });
                         html += `</div>`;
                     });
                     container.innerHTML = html;
                 } catch (e) {
                     container.innerHTML = "Error generating quiz.";
                 }
             }
        }
        window.checkAnswer = function(btn, isCorrect) {
            if (isCorrect) {
                btn.style.background = 'var(--success)';
                btn.innerHTML += ' ✅';
            } else {
                btn.style.background = 'var(--error)';
                btn.innerHTML += ' ❌';
            }
        };
        function renderCard() {
            const cardEl = document.getElementById('activeFlashcard');
            const content = document.getElementById('cardContent');
            const card = flashcardDeck[currentCardIdx];
            cardEl.style.transform = 'rotateY(0deg)'; 
            isCardFlipped = false;
            content.innerHTML = `
                <h3 style="color:var(--primary); margin-bottom:1rem;">Card ${currentCardIdx + 1}/${flashcardDeck.length}</h3>
                <div style="font-size:1.4rem; font-weight:bold;">${card.q}</div>
                <div style="margin-top:2rem; color:#888; font-size:0.9rem;">(Tap to Flip)</div>
            `;
        }
        function flipCard() {
            const content = document.getElementById('cardContent');
            const card = flashcardDeck[currentCardIdx];
            isCardFlipped = !isCardFlipped;
            if (isCardFlipped) {
                content.innerHTML = `
                    <h3 style="color:var(--success); margin-bottom:1rem;">Answer</h3>
                    <div style="font-size:1.4rem;">${card.a}</div>
                    <div style="margin-top:2rem; color:#888; font-size:0.9rem;">(Tap for Question)</div>
                `;
            } else {
                renderCard(); 
                isCardFlipped = false; 
            }
            hapticFeedback();
        }
        function nextCard() {
            if (currentCardIdx < flashcardDeck.length - 1) { currentCardIdx++; renderCard(); }
        }
        function prevCard() {
            if (currentCardIdx > 0) { currentCardIdx--; renderCard(); }
        }
        function readCard() {
            const card = flashcardDeck[currentCardIdx];
            speakText(isCardFlipped ? card.a : card.q);
        }
        async function generateRealDiagram() {
            const prompt = document.getElementById('diagramPrompt').value;
            const container = document.getElementById('svgContainer');
            const descArea = document.getElementById('diagramDesc');
            if (!prompt) return;
            container.innerHTML = '<div class="loader"></div> Generating...';
            const aiPrompt = `Create a high-contrast SVG diagram: "${prompt}". Return ONLY <svg> code. End with |||Description`;
            const rawResponse = await callGemini(aiPrompt);
            if (rawResponse) {
                const parts = rawResponse.split('|||');
                container.innerHTML = parts[0].replace(/```xml|```svg|```/g, '').trim();
                descArea.textContent = parts[1] || "Visual diagram.";
                speakText("Diagram generated. " + descArea.textContent);
            }
        }
        async function runAISummary() {
             const text = document.getElementById('textInput').value;
             if (!text) return;
             document.getElementById('summaryOutput').innerHTML = "Summarizing...";
             const resp = await callGemini("Summarize: " + text);
             if (resp) document.getElementById('summaryOutput').innerHTML = parseMarkdown(resp);
        }
        function speakText(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
        }
        function speakInputText() { speakText(document.getElementById('textInput').value); }
        function toggleDictation(targetId) {
            if (!('webkitSpeechRecognition' in window)) { alert("Use Chrome for Speech Rec."); return; }
            if (isRecording) { recognition.stop(); return; }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.onstart = () => { isRecording = true; hapticFeedback(); };
            recognition.onend = () => { isRecording = false; hapticFeedback(); };
            recognition.onresult = (e) => {
                const trans = e.results[0][0].transcript;
                const el = document.getElementById(targetId);
                el.value += (el.value ? " " : "") + trans;
            };
            recognition.start();
        }
        function hapticFeedback() {
            if (navigator.vibrate) navigator.vibrate(50);
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function parseMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('study_skills_api_key', key);
                API_KEY = key;
                document.getElementById('apiKeyWarning').classList.add('hidden');
            }
            const theme = document.getElementById('themeSelect').value;
            localStorage.setItem('study_theme', theme);
            document.body.setAttribute('data-theme', theme);
            const accent = document.getElementById('accentColorInput').value;
            localStorage.setItem('study_accent', accent);
            document.documentElement.style.setProperty('--primary', accent);
            const fs = document.getElementById('fontSizeSlider').value;
            localStorage.setItem('study_fontSize', fs);
            document.documentElement.style.fontSize = fs + 'px';
            const hc = document.getElementById('highContrastToggle').checked;
            localStorage.setItem('study_highContrast', hc);
            if (hc) document.body.setAttribute('data-theme', 'high-contrast');
            document.getElementById('settingsModal').style.display = 'none';
        }
        window.addEventListener('load', () => {
             const key = localStorage.getItem('study_skills_api_key');
             if (key) {
                 document.getElementById('apiKeyInput').value = key;
                 document.getElementById('apiKeyWarning').classList.add('hidden');
             } else {
                 document.getElementById('apiKeyWarning').classList.remove('hidden');
             }
             const theme = localStorage.getItem('study_theme') || 'light';
             document.getElementById('themeSelect').value = theme;
             document.body.setAttribute('data-theme', theme);
             const accent = localStorage.getItem('study_accent') || '#1976d2';
             document.getElementById('accentColorInput').value = accent;
             document.documentElement.style.setProperty('--primary', accent);
             renderCard();
             document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
             document.getElementById('settingsBtn').addEventListener('click', () => {
                 document.getElementById('settingsModal').style.display = 'block';
             });
             document.getElementById('closeSettings').addEventListener('click', () => {
                 document.getElementById('settingsModal').style.display = 'none';
             });
             const accessFontSize = document.getElementById('accessFontSize');
             if (accessFontSize) {
                 const storedFs = localStorage.getItem('study_fontSize') || '16';
                 accessFontSize.value = storedFs;
                 document.documentElement.style.fontSize = storedFs + 'px';
                 accessFontSize.addEventListener('input', (e) => {
                     const fs = e.target.value;
                     document.documentElement.style.fontSize = fs + 'px';
                     localStorage.setItem('study_fontSize', fs);
                 });
             }
             const textSpacingToggle = document.getElementById('textSpacingToggle');
             if (textSpacingToggle) {
                 textSpacingToggle.addEventListener('change', (e) => {
                     document.body.style.letterSpacing = e.target.checked ? '0.05em' : '';
                     document.body.style.wordSpacing = e.target.checked ? '0.1em' : '';
                 });
             }
             const dyslexiaToggle = document.getElementById('dyslexiaToggle');
             if (dyslexiaToggle) {
                 dyslexiaToggle.addEventListener('change', (e) => {
                     document.body.classList.toggle('dyslexia-font', e.target.checked);
                 });
             }
             const reducedMotionToggle = document.getElementById('reducedMotionToggle');
             if (reducedMotionToggle) {
                 reducedMotionToggle.addEventListener('change', (e) => {
                     document.body.classList.toggle('reduced-motion', e.target.checked);
                 });
             }
             const focusOutlineToggle = document.getElementById('focusOutlineToggle');
             if (focusOutlineToggle) {
                 focusOutlineToggle.addEventListener('change', (e) => {
                     document.body.classList.toggle('show-focus-outlines', e.target.checked);
                 });
             }
             const invertColorsToggle = document.getElementById('invertColorsToggle');
             if (invertColorsToggle) {
                 invertColorsToggle.addEventListener('change', (e) => {
                     document.body.classList.toggle('invert-colors', e.target.checked);
                 });
             }
             const screenReaderToggle = document.getElementById('screenReaderToggle');
             if (screenReaderToggle) {
                 screenReaderToggle.addEventListener('change', (e) => {
                     localStorage.setItem('study_sr', e.target.checked);
                 });
             }
        });
        function readCurrentView() {
            const activeTab = document.querySelector('.tab-link.active');
            const panel = document.querySelector('.tab-content[style*="display: block"]');
            const msg = (activeTab?.textContent || '') + ". " + (panel?.innerText || '').substring(0,800);
            speakText(msg);
        }
        function showKeyboardShortcuts() { alert("M: Mic\nS: Send\nEsc: Close"); }
    </script>
    <div id="srLive" class="sr-live" aria-live="polite"></div>
</body>
</html>